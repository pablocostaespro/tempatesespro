(function(t){function i(i,s){this.code='<div class="postit"><div class="barra"></div><a href="#" class="minimizar">-</a><a href="#" class="fechar">x</a><textarea maxlength="140" class="animate-all-5ms" placeholder="Digite seu texto"></textarea></div>',this.postits=[],this.intervalo=0,this.container=t("#page-top"),this.data=s||{id:i,message:"",pos:null},this.init()}var s=new Date,e=7200;s.setTime(s.getTime()+60*e*1e3);var a=new ScormData,n={init:function(){var s=this;this.postits=[],this.highlights={},this.dados={highlights:this.highlights,postits:this.postits},this.dados=t.extend({},this.dados,JSON.parse(a.get("cmi.suspend_data")||"{}")),document.addEventListener("setHighlight",function(t){s.highlights={highlights:t.detail},s.gravaScorm()}),document.addEventListener("setPostit",function(t){var i=s.postits.findIndex(function(i){return i.id==t.detail.id});-1==i?s.postits.push(t.detail):(s.postits[i]=t.detail,t.detail.remove&&s.postits.splice(i,1)),s.gravaScorm()});for(var e=0;e<this.dados.postits.length;e++)new i(this.dados.postits[e].id,this.dados.postits[e]);h.init(this.dados.highlights.highlights),t(document).bind("habilitaHighlight",function(){h.habilitaHighlight()}),t(document).bind("inserePostit",function(){var t=0;s.postits.length&&(t=Math.max.apply(Math,s.postits.map(function(t){return t.id})));new i(t+1)})},gravaScorm:function(){var i={postits:this.postits,highlights:this.highlights},s=JSON.parse(a.get("cmi.suspend_data")||"{}");s=t.extend({},s,i),a.set("cmi.suspend_data",JSON.stringify(s))}},h={enabled:!1,obj:null,pg:null,hightlights:[],objhightlights:{},highlighter:null,init:function(i){var s=this;t("#menu-button").bind("click",function(t){t.preventDefault(),s.habilitaHighlight()}),this.objhightlights.message=i,s.carregaHighlight()},setBindClick:function(){var i=this;t(this.obj).find(".highlighted").unbind("click"),t(this.obj).find(".highlighted").bind("click",function(){i.removeHighlights(this)})},carregaHighlight:function(t){var i=this,s=document.body;this.obj=s;var e={onBeforeHighlight:function(t,i){return!!h.enabled},onAfterHighlight:function(t){var s=i.objhightlights.textHighlighter.serializeHighlights();i.setBindClick(),i.gravaHighlight(s)}};this.objhightlights.textHighlighter=new TextHighlighter(s,e),this.objhightlights.textHighlighter.deserializeHighlights(this.objhightlights.message),this.setBindClick()},tagsToRemove:["strong","a","b","i","em","sub","sup"],removeHighlights:function(i){if(h.enabled){var s=this.objhightlights.textHighlighter,e=t(i),a=e.find(h.tagsToRemove.join(",")).length;a>0?e.text().replace(/\s+/g,"")==t(obj).text().replace(/\s+/g,"")&&e.find(".highlighted").each(function(t,i){s.removeHighlights(this)}):s.removeHighlights(e[0]);var n=s.serializeHighlights();this.gravaHighlight(n)}},gravaHighlight:function(t){this.objhightlights.message=t;var i=new CustomEvent("setHighlight",{detail:t});document.dispatchEvent(i)},habilitaHighlight:function(){h.enabled=!h.enabled}};i.prototype.init=function(){this.inserePostit()},i.prototype.inserePostit=function(){var i,s=this;this.data.message;this.obj=t(this.code),this.container.append(this.obj),this.obj.find(".fechar").bind("click",function(t){t.preventDefault(),s.removePostit()}),this.obj.find(".minimizar").bind("click",function(t){t.preventDefault(),s.minimizaPostit()}),this.obj.find("textarea").bind("keyup",function(){s.data.message=t(this).val(),s.gravaPostit()}),this.data.pos||(this.data.pos={x:window.scrollX+t(".container").first().offset().left,y:window.scrollY-this.container.offset().top+80}),this.obj.draggable({containment:"parent",handle:".barra",cancel:"input,textarea,button,select,option",drag:function(){s.data.pos={x:parseInt(s.obj.css("left")),y:parseInt(s.obj.css("top"))},s.data.message=s.obj.find("textarea").val(),clearInterval(i),i=setInterval(function(){s.gravaPostit(),clearInterval(i)},100)}}),this.obj.find("textarea").val(this.data.message),this.obj.css({left:this.data.pos.x,top:this.data.pos.y}),"transition"==t.support.transition||t.support.transition?this.obj.css({opacity:0,perspective:"200px",rotateX:"90deg",rotateZ:"0",y:"-600px"}).transition({opacity:1,rotateX:0,rotateZ:10,y:0},500):(this.obj.css({opacity:0,transform:"translateY(-70px)"}),this.obj.animate({opacity:1,transform:"translateY(0)"},300,function(){})),this.gravaPostit(this.data)},i.prototype.minimizaPostit=function(t){this.obj.toggleClass("fechado")},i.prototype.removePostit=function(){this.data.remove=!0,this.gravaPostit(),this.obj.animate({transform:"scale(0.01,0.01)"},500,"easeInBack",function(){t(this).remove()})},i.prototype.gravaPostit=function(){var t=this,i=new CustomEvent("setPostit",{detail:t.data});clearInterval(this.intervalo),this.intervalo=setInterval(function(){clearInterval(t.intervalo),document.dispatchEvent(i)},100)},t(document).bind("contentLoaded",function(){n.init()})})(jQuery);