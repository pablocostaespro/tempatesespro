(function(e){"use strict";function t(e,t){return g(e).color()===g(t).color()}function n(e,t){for(var n in e=e||{},t)t.hasOwnProperty(n)&&void 0===e[n]&&(e[n]=t[n]);return e}function i(e){return e.filter(function(e,t,n){return n.indexOf(e)===t})}function o(e){var t=e.startContainer,n=e.endContainer,i=e.commonAncestorContainer,o=!0;if(0===e.endOffset){for(;!n.previousSibling&&n.parentNode!==i;)n=n.parentNode;n=n.previousSibling}else n.nodeType===d.TEXT_NODE?e.endOffset<n.nodeValue.length&&n.splitText(e.endOffset):e.endOffset>0&&(n=n.childNodes.item(e.endOffset-1));return t.nodeType===d.TEXT_NODE?e.startOffset===t.nodeValue.length?o=!1:e.startOffset>0&&(t=t.splitText(e.startOffset),n===t.previousSibling&&(n=t)):t=e.startOffset<t.childNodes.length?t.childNodes.item(e.startOffset):t.nextSibling,{startContainer:t,endContainer:n,goDeeper:o}}function r(e,t){e.sort(function(e,n){return g(t?n:e).parents().length-g(t?e:n).parents().length})}function l(e){var t=[],n={},i=[];return e.forEach(function(e){var i=e.getAttribute(c);void 0===n[i]&&(n[i]=[],t.push(i)),n[i].push(e)}),t.forEach(function(e){var t=n[e];i.push({chunks:t,timestamp:e,toString:function(){return t.map(function(e){return e.textContent}).join("")}})}),i}function s(e,t){e.addEventListener("mouseup",t.highlightHandler.bind(t)),e.addEventListener("touchend",t.highlightHandler.bind(t))}function a(e,t){e.removeEventListener("mouseup",t.highlightHandler.bind(t)),e.removeEventListener("touchend",t.highlightHandler.bind(t))}function h(e,t){if(!e)throw"Missing anchor element";this.el=e,this.options=n(t,{color:"#ffff7b",highlightedClass:"highlighted",contextClass:"highlighter-context",onRemoveHighlight:function(){return!0},onBeforeHighlight:function(){return!0},onAfterHighlight:function(){}}),g(this.el).addClass(this.options.contextClass),s(this.el,this)}var u="dh",c="dt",d={ELEMENT_NODE:1,TEXT_NODE:3},f=["SCRIPT","STYLE","SELECT","OPTION","BUTTON","OBJECT","APPLET","VIDEO","AUDIO","CANVAS","EMBED","PARAM","METER","PROGRESS"],g=function(e){return{addClass:function(t){e.classList?e.classList.add(t):e.className+=" "+t},removeClass:function(t){e.classList?e.classList.remove(t):e.className=e.className.replace(new RegExp("(^|\\b)"+t+"(\\b|$)","gi")," ")},prepend:function(t){for(var n=Array.prototype.slice.call(t),i=n.length;i--;)e.insertBefore(n[i],e.firstChild)},append:function(t){for(var n=Array.prototype.slice.call(t),i=0,o=n.length;i<o;++i)e.appendChild(n[i])},insertAfter:function(t){return t.parentNode.insertBefore(e,t.nextSibling)},insertBefore:function(t){return t.parentNode.insertBefore(e,t)},remove:function(){e.parentNode.removeChild(e),e=null},contains:function(t){return e!==t&&e.contains(t)},wrap:function(t){return e.parentNode&&e.parentNode.insertBefore(t,e),t.appendChild(e),t},unwrap:function(){var t,n=Array.prototype.slice.call(e.childNodes);return n.forEach(function(e){t=e.parentNode,g(e).insertBefore(e.parentNode),g(t).remove()}),n},parents:function(){for(var t,n=[];t=e.parentNode;)n.push(t),e=t;return n},normalizeTextNodes:function(){if(e){if(e.nodeType===d.TEXT_NODE)for(;e.nextSibling&&e.nextSibling.nodeType===d.TEXT_NODE;)e.nodeValue+=e.nextSibling.nodeValue,e.parentNode.removeChild(e.nextSibling);else g(e.firstChild).normalizeTextNodes();g(e.nextSibling).normalizeTextNodes()}},color:function(){return e.style.backgroundColor},fromHTML:function(e){var t=document.createElement("div");return t.innerHTML=e,t.childNodes},getRange:function(){var t,n=g(e).getSelection();return n.rangeCount>0&&(t=n.getRangeAt(0)),t},removeAllRanges:function(){var t=g(e).getSelection();t.removeAllRanges()},getSelection:function(){return g(e).getWindow().getSelection()},getWindow:function(){return g(e).getDocument().defaultView},getDocument:function(){return e.ownerDocument||e}}};h.prototype.destroy=function(){a(this.el,this),g(this.el).removeClass(this.options.contextClass)},h.prototype.highlightHandler=function(){this.doHighlight()},h.prototype.doHighlight=function(e){var t,n,i,o,r=g(this.el).getRange();r&&!r.collapsed&&(!0===this.options.onBeforeHighlight(r)&&(o=+new Date,t=h.createWrapper(this.options),n=this.highlightRange(r,t),i=this.normalizeHighlights(n),this.options.onAfterHighlight(r,i,o)),e||g(this.el).removeAllRanges())},h.prototype.highlightRange=function(e,t){if(!e||e.collapsed)return[];var n,i,r,l=o(e),s=l.startContainer,a=l.endContainer,h=l.goDeeper,c=!1,p=s,v=[];do{h&&p.nodeType===d.TEXT_NODE&&(-1===f.indexOf(p.parentNode.tagName)&&""!==p.nodeValue.trim()&&(i=t.cloneNode(!0),i.setAttribute(u,!0),r=p.parentNode,(g(this.el).contains(r)||r===this.el)&&(n=g(p).wrap(i),v.push(n))),h=!1),p!==a||a.hasChildNodes()&&h||(c=!0),p.tagName&&f.indexOf(p.tagName)>-1&&(a.parentNode===p&&(c=!0),h=!1),h&&p.hasChildNodes()?p=p.firstChild:p.nextSibling?(p=p.nextSibling,h=!0):(p=p.parentNode,h=!1)}while(!c);return v},h.prototype.normalizeHighlights=function(e){var t;return this.flattenNestedHighlights(e),this.mergeSiblingHighlights(e),t=e.filter(function(e){return e.parentElement?e:null}),t=i(t),t.sort(function(e,t){return e.offsetTop-t.offsetTop||e.offsetLeft-t.offsetLeft}),t},h.prototype.flattenNestedHighlights=function(e){function n(){var n=!1;return e.forEach(function(i,r){var l=i.parentElement,s=l.previousSibling,a=l.nextSibling;o.isHighlight(l)&&(t(l,i)?(l.replaceChild(i.firstChild,i),e[r]=l,n=!0):(i.nextSibling||(g(i).insertBefore(a||l),n=!0),i.previousSibling||(g(i).insertAfter(s||l),n=!0),l.hasChildNodes()||g(l).remove()))}),n}var i,o=this;r(e,!0);do{i=n()}while(i)},h.prototype.mergeSiblingHighlights=function(e){function n(e,n){return n&&n.nodeType===d.ELEMENT_NODE&&t(e,n)&&i.isHighlight(n)}var i=this;e.forEach(function(e){var t=e.previousSibling,i=e.nextSibling;n(e,t)&&(g(e).prepend(t.childNodes),g(t).remove()),n(e,i)&&(g(e).append(i.childNodes),g(i).remove()),g(e).normalizeTextNodes()})},h.prototype.setColor=function(e){this.options.color=e},h.prototype.getColor=function(){return this.options.color},h.prototype.removeHighlights=function(e){function t(e){var t=e.previousSibling,n=e.nextSibling;t&&t.nodeType===d.TEXT_NODE&&(e.nodeValue=t.nodeValue+e.nodeValue,g(t).remove()),n&&n.nodeType===d.TEXT_NODE&&(e.nodeValue=e.nodeValue+n.nodeValue,g(n).remove())}function n(e){var n=g(e).unwrap();n.forEach(function(e){t(e)})}var i=e||this.el,o=this.getHighlights({container:i}),l=this;r(o,!0),o.forEach(function(e){!0===l.options.onRemoveHighlight(e)&&n(e)})},h.prototype.getHighlights=function(e){e=n(e,{container:this.el,andSelf:!0,grouped:!1});var t=e.container.querySelectorAll("["+u+"]"),i=Array.prototype.slice.call(t);return!0===e.andSelf&&e.container.hasAttribute(u)&&i.push(e.container),e.grouped&&(i=l(i)),i},h.prototype.isHighlight=function(e){return e&&e.nodeType===d.ELEMENT_NODE&&e.hasAttribute(u)},h.prototype.serializeHighlights=function(){function e(e,t){var n,i=[];do{n=Array.prototype.slice.call(e.parentNode.childNodes),i.unshift(n.indexOf(e)),e=e.parentNode}while(e!==t||!e);return i}var t=this.getHighlights(),n=this.el,i=[];return r(t,!1),t.forEach(function(t){var o=0,r=t.textContent.length,l=e(t,n),s=t.cloneNode(!0);s.innerHTML="",s=s.outerHTML,t.previousSibling&&t.previousSibling.nodeType===d.TEXT_NODE&&(o=t.previousSibling.length),i.push([l.join(":"),o,r])}),JSON.stringify(i)},h.prototype.deserializeHighlights=function(e){function t(e){for(var t,n,r,l={wrapper:"<span class='highlighted' dh='true'></span>",path:e[0].split(":"),offset:e[1],length:e[2]},s=l.path.pop(),a=o.el;r=l.path.shift();)a=a.childNodes[r];a.childNodes[s-1]&&a.childNodes[s-1].nodeType===d.TEXT_NODE&&(s-=1),a=a.childNodes[s],t=a.splitText(l.offset),t.splitText(l.length),t.nextSibling&&!t.nextSibling.nodeValue&&g(t.nextSibling).remove(),t.previousSibling&&!t.previousSibling.nodeValue&&g(t.previousSibling).remove(),n=g(t).wrap(g().fromHTML(l.wrapper)[0]),i.push(n)}var n,i=[],o=this;if(!e)return i;try{n=JSON.parse(e)}catch(e){throw"Can't parse JSON: "+e}return n.forEach(function(e){try{t(e)}catch(e){console&&console.warn&&console.warn("Can't deserialize highlight descriptor. Cause: "+e)}}),i},h.prototype.find=function(e,t){var n=g(this.el).getWindow(),i=n.scrollX,o=n.scrollY,r=void 0===t||t;if(g(this.el).removeAllRanges(),n.find)for(;n.find(e,r);)this.doHighlight(!0);else if(n.document.body.createTextRange){var l=n.document.body.createTextRange();for(l.moveToElementText(this.el);l.findText(e,1,r?4:0)&&(g(this.el).contains(l.parentElement())||l.parentElement()===this.el);)l.select(),this.doHighlight(!0),l.collapse(!1)}g(this.el).removeAllRanges(),n.scrollTo(i,o)},h.createWrapper=function(e){var t=document.createElement("span");return t.className=e.highlightedClass,t},e.TextHighlighter=h})(window);